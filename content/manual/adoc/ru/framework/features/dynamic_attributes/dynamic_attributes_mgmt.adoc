:sourcesdir: ../../../../../source

[[dynamic_attributes_mgmt]]
===== Управление динамическими атрибутами

Управление категориями и описаниями атрибутов осуществляется с помощью специальных экранов, доступных через меню *Administration → Dynamic Attributes*.

.Экран списка категорий
image::categoryBrowser.png[align="center"]

Редактор категорий позволяет создать категорию для выбранного типа сущности и добавить в нее набор динамических атрибутов. Для категории обязательно указывается имя и соответствующий тип сущности. Флажок *Default* указывает, что данная категория будет автоматически выбрана для нового экземпляра сущности, реализующей интерфейс `Categorized`.

.Экран редактирования категории
image::categoryEditor.png[align="center"]

Секция *Name localization* отображается, если приложение поддерживает более одного языка, и позволяет задать локализованное значение имени категории для каждой доступной локали.

.Локализация имени категории
image::categoryLocalization.png[align="center"]

[[dynamic_attributes_mgmt_attr_location]]
На вкладке *Attributes Location* вы можете настроить расположение каждого динамического атрибута внутри <<categorized_entity,DynamicAttributesPanel>>.

.Настройка расположения атрибутов
image::dynamic_attributes_location.png[align="center"]

Укажите количество колонок в выпадающем списке *Columns count*. Перетащите атрибут из списка атрибутов в нужный столбец и нужную строку. Вы можете добавлять пустые ячейки и менять порядок отображения атрибутов. После внесения изменений нажмите на кнопку *Save configuration*.

Расположение атрибутов на панели `DynamicAttributesPanel` в редакторе сущности:

image::dynamic_attributes_location_rezult.png[align="center"]

Редактор динамического атрибута позволяет задать имя, системный код, описание, тип значения, значение атрибута по умолчанию и скрипт валидации.

.Редактор динамического атрибута
image::runtimePropertyEditor.png[align="center"]

Для всех типов значения, кроме `Boolean`, доступно поле *Width*, позволяющее задать ширину поля в `Form` в пикселах или процентах. Если поле *Width* не заполнено, его значение по умолчанию равно 100%.

Для всех типов значения, кроме `Boolean`, также доступен чекбокс *Is collection*. Он позволяет создавать динамические атрибуты выбранного типа со множеством значений.

Для всех числовых типов значений: `Double`, `Fixed-point number`, `Integer` – доступны следующие поля:

* *Minimum value* – при вводе значения атрибута просходит проверка, что значение должно быть больше или равно указанному минимальному значению.

* *Maximum value* – при вводе значения атрибута просходит проверка, что значение должно быть меньше или равно указанному максимальному значению.

Для типа значения `Fixed-point number` доступно поле **Number format pattern**, в котором можно задать паттерн форматирования. Паттерн задается по правилам, описанным в https://docs.oracle.com/javase/8/docs/api/java/text/DecimalFormat.html[DecimalFormat].

Для всех типов значений есть возможность указать скрипт валидации в поле **Validation script** для проверки значения, введенного пользователем. Логика валидации задается в скрипте Groovy. В случае неуспешной валидации Groovy скрипт должен вернуть сообщение об ошибке. В противном случае скрипт не должен возвращать ничего или может вернуть `null`. Проверяемое значение доступно в скрипте в переменной `value`. Для сообщения об ошибке используется Groovy строка, ключ `$value` может быть использован в сообщении для формирования результата.

Пример:

[source, groovy]
----
include::{sourcesdir}/features/dynamicAttrValidation.groovy[]
----

Для типа значения `Enumeration` множество значений перечисления задаётся в поле *Enumeration* в редакторе списка.

.Редактор динамического атрибута для типа значений `Enumeration`
image::runtimePropertyEnum.png[align="center"]

Каждое значение перечисления может быть локализовано на языки, доступные в приложении:

.Локализация динамического атрибута для типа значений `Enumeration`
image::runtimePropertyEnumLocalization.png[align="center"]

Рассмотрим вкладку *Calculated values and options*. В поле *Attribute depends on* вы можете указать, от каких атрибутов зависит текущий атрибут. При изменении значения одного из этих атрибутов будет пересчитан либо скрипт для вычисления значения атрибута, либо скрипт для вычисления списка возможных значений.

Groovy скрипт для вычисления значения атрибута задается в поле *Recalculation value script*. Скрипт должен возвращать новое значение параметра. В скрипт передаются следующие переменные:

* `entity` – редактируемая сущность;
* `dynamicAttributes` – мэп, где `key` – код атрибута, `value` – значение динамического атрибута.

.Скрипт пересчета значения
image::dynamic_attributes_recalculation.png[align="center"]

Скрипт можно задать следующим образом, используя мэп `dynamicAttributes`:

[source, groovy]
----
include::{sourcesdir}/features/dynamicAttrValidationRecalculation.groovy[]
----

Скрипт выполняется каждый раз после изменения значения одного из атрибутов, от которых зависит данный атрибут.

Если скрипт задан, то поле ввода для атрибута будет нередактируемым.

Пересчет значения атрибута работает только со следующими веб-компонентами: <<gui_Form,Form>>, <<categorized_entity,DynamicAttributesPanel>>.

Для всех типов значения поддерживается локализация имени атрибута на вкладке *Localization*:

.Локализация динамического атрибута
image::runtimePropertyLocalization.png[align="center"]

Динамический атрибут также имеет настройки видимости, описывающие, на каких экранах его нужно отображать. По умолчанию атрибут не отображается нигде.

.Настройки видимости динамического атрибута
image::runtimePropertyVisibility.png[align="center"]

Кроме экрана можно также указать компонент, в котором атрибут должен появляться (например, для экранов, где несколько компонентов <<gui_FieldGroup,FieldGroup>> показывают поля одной и той же сущности).

Если атрибут отмечен как видимый на каком-либо экране, он автоматически отобразится во всех группах полей и таблицах, отображающих объекты данного типа в данном экране.

Доступ к динамическим атрибутам также может быть ограничен через настройки в <<roles,ролях пользователей>>. Настройки осуществляются так же, как для обычных атрибутов.

Для того чтобы изменения в атрибутах и настройках видимости вступили в силу, необходимо нажать кнопку *Применить изменения* на экране со списком категорий. Изменения также можно применить через *Administration → JMX Console*, вызвав метод `clearDynamicAttributesCache()` JMX бина `app-core.cuba:type=CachingFacade`.

Ниже изображен динамический атрибут, добавленный в экран автоматически путем задания настроек отображения атрибута:

image::runtimePropsApplyChanges.png[align="center"]

Динамические атрибуты можно добавить в экран вручную. Для этого необходимо выполнить следующее:

* В секции `dsContext` XML-дескриптора экрана для источника данных с загружаемой сущностью (сущностями) установить в `true` признак `loadDynamicAttributes` для источника данных с загружаемой сущностью (сущностями), например:
+
[source, xml]
----
<dsContext>
  <datasource id="carDs" class="com.company.sample.entity.Car" view="_local" loadDynamicAttributes="true"/>
</dsContext>
----

* В описании визуального компонента в качестве `property` нужно использовать код динамического атрибута с префиксом `+++++`:
+
[source, xml]
----
<textField id="numberOfSeats" datasource="carDs" property="+numberOfSeats"/>
----

